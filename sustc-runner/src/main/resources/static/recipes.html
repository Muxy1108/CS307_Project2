<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Recipe Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#f7f7f9; }
        .container { max-width: 1200px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .truncate { max-width: 360px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .muted { color:#6c757d; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="mb-0">Recipes</h3>
            <div class="muted">数据来自 <span class="mono">GET /api/recipes/search</span></div>
        </div>
        <div id="status" class="muted"></div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">关键字（Name/Description）</label>
                    <input id="keyword" class="form-control" placeholder="e.g. chicken">
                </div>
                <div class="col-md-3">
                    <label class="form-label">分类</label>
                    <input id="category" class="form-control" placeholder="e.g. Dessert">
                </div>
                <div class="col-md-2">
                    <label class="form-label">最低评分</label>
                    <input id="minRating" type="number" step="0.1" min="0" max="5" class="form-control" placeholder="0~5">
                </div>
                <div class="col-md-3">
                    <label class="form-label">排序</label>
                    <select id="sort" class="form-select">
                        <option value="">默认（RecipeId ASC）</option>
                        <option value="rating_desc">评分高到低</option>
                        <option value="date_desc">发布时间新到旧</option>
                        <option value="calories_asc">卡路里低到高</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">每页条数</label>
                    <select id="size" class="form-select">
                        <option>10</option>
                        <option selected>20</option>
                        <option>50</option>
                        <option>100</option>
                    </select>
                </div>

                <div class="col-md-10 d-flex gap-2">
                    <button class="btn btn-primary" id="btnSearch">查询</button>
                    <button class="btn btn-outline-secondary" id="btnReset">重置</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <span class="badge text-bg-secondary" id="totalBadge">total: 0</span>
                    <span class="muted ms-2" id="pageInfo">page 1</span>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" id="prevBtn">上一页</button>
                    <button class="btn btn-outline-primary btn-sm" id="nextBtn">下一页</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th class="mono">ID</th>
                        <th>名称</th>
                        <th>作者</th>
                        <th>分类</th>
                        <th>评分</th>
                        <th>评论数</th>
                        <th>卡路里</th>
                        <th>发布日期</th>
                        <th>配料（预览）</th>
                    </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>

            <div id="hint" class="muted small"></div>
        </div>
    </div>
</div>

<script>
    let page = 1;

    function fmtDate(ms) {
        if (ms === null || ms === undefined) return '';
        const d = new Date(ms);
        if (isNaN(d.getTime())) return '';
        return d.toISOString().slice(0, 10); // YYYY-MM-DD
    }

    function safe(v) {
        return (v === null || v === undefined) ? '' : String(v);
    }

    function ingredientsPreview(arr) {
        if (!Array.isArray(arr) || arr.length === 0) return '';
        const head = arr.slice(0, 3).join(', ');
        return arr.length > 3 ? head + ' ...' : head;
    }

    async function load() {
        const keyword = document.getElementById('keyword').value.trim();
        const category = document.getElementById('category').value.trim();
        const minRating = document.getElementById('minRating').value.trim();
        const size = parseInt(document.getElementById('size').value, 10);
        const sort = document.getElementById('sort').value;

        const params = new URLSearchParams();
        params.set('page', page);
        params.set('size', size);
        if (keyword) params.set('keyword', keyword);
        if (category) params.set('category', category);
        if (minRating) params.set('minRating', minRating);
        if (sort) params.set('sort', sort);

        const url = '/api/recipes/search?' + params.toString();
        document.getElementById('status').textContent = 'Loading...';

        try {
            const resp = await fetch(url);
            if (!resp.ok) {
                document.getElementById('status').textContent = `HTTP ${resp.status}`;
                document.getElementById('hint').textContent =
                    '若出现 404，请确认启动时启用了 server profile（因为 Controller 有 @Profile("server")）。';
                return;
            }

            const data = await resp.json();
            const items = Array.isArray(data.items) ? data.items : [];

            document.getElementById('totalBadge').textContent = 'total: ' + safe(data.total);
            document.getElementById('pageInfo').textContent = `page ${safe(data.page)} / size ${safe(data.size)}`;
            document.getElementById('status').textContent = '';

            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';

            for (const r of items) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="mono">${safe(r.recipeId)}</td>
          <td class="truncate" title="${safe(r.name)}">${safe(r.name)}</td>
          <td class="truncate" title="${safe(r.authorName)}">${safe(r.authorName)} <span class="muted">(#${safe(r.authorId)})</span></td>
          <td>${safe(r.recipeCategory)}</td>
          <td>${safe(r.aggregatedRating)}</td>
          <td>${safe(r.reviewCount)}</td>
          <td>${safe(r.calories)}</td>
          <td class="mono">${fmtDate(r.datePublished)}</td>
          <td class="truncate" title="${Array.isArray(r.recipeIngredientParts) ? r.recipeIngredientParts.join(', ') : ''}">
            ${ingredientsPreview(r.recipeIngredientParts)}
          </td>
        `;
                tbody.appendChild(tr);
            }

            const total = Number(data.total || 0);
            const maxPage = Math.max(1, Math.ceil(total / size));
            document.getElementById('prevBtn').disabled = (page <= 1);
            document.getElementById('nextBtn').disabled = (page >= maxPage);

            document.getElementById('hint').textContent =
                `已加载 ${items.length} 条；最大页数 ${maxPage}；请求：${url}`;

        } catch (e) {
            document.getElementById('status').textContent = 'Error';
            document.getElementById('hint').textContent = String(e);
        }
    }

    document.getElementById('btnSearch').addEventListener('click', () => { page = 1; load(); });
    document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('keyword').value = '';
        document.getElementById('category').value = '';
        document.getElementById('minRating').value = '';
        document.getElementById('sort').value = '';
        document.getElementById('size').value = '20';
        page = 1;
        load();
    });
    document.getElementById('prevBtn').addEventListener('click', () => { page = Math.max(1, page - 1); load(); });
    document.getElementById('nextBtn').addEventListener('click', () => { page = page + 1; load(); });

    load();
</script>
</body>
</html>
